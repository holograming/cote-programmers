name: Sync to Notion

on:
  push:
    branches:
      - main
    paths:
      - 'í”„ë¡œê·¸ë˜ë¨¸ìŠ¤/**'

jobs:
  sync:
    name: Sync changed problems to Notion
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Configure git for Korean filenames
        run: git config --global core.quotepath false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: Install dependencies
        run: |
          pip install requests python-dotenv

      - name: Detect changed README files
        id: changed-files
        run: |
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ë„ í¬í•¨)
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            # --diff-filter=ACMRT: Added(A), Copied(C), Modified(M), Renamed(R), Type changed(T)
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT HEAD^ HEAD | grep -E 'README\.md$' | grep '^í”„ë¡œê·¸ë˜ë¨¸ìŠ¤/' || true)
          else
            # ì´ˆê¸° ì»¤ë°‹ì¸ ê²½ìš° ëª¨ë“  README íŒŒì¼ ì²˜ë¦¬
            CHANGED_FILES=$(git ls-files 'README.md' | grep '^í”„ë¡œê·¸ë˜ë¨¸ìŠ¤/' || true)
          fi

          # ë””ë²„ê·¸: ê°ì§€ëœ íŒŒì¼ ëª©ë¡ ì¶œë ¥
          echo "DEBUG: Changed files detected:"
          echo "$CHANGED_FILES"
          echo "---"

          if [ -z "$CHANGED_FILES" ]; then
            echo "ë³€ê²½ëœ README íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ë³€ê²½ëœ README íŒŒì¼:"
            echo "$CHANGED_FILES"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # JSON ë°°ì—´ë¡œ ë³€í™˜
            README_ARRAY=$(echo "$CHANGED_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "readme_files=$README_ARRAY" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification (Start)
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "â­ï¸ SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          README_FILES='${{ steps.changed-files.outputs.readme_files }}'
          FILE_COUNT=$(echo "$README_FILES" | jq 'length')

          # íŒŒì¼ ëª©ë¡ ìƒì„±
          FILE_LIST=$(echo "$README_FILES" | jq -r '.[]' | sed 's/^/â€¢ /')

          PAYLOAD=$(cat <<EOF
          {
            "text": "ğŸš€ Notion ë™ê¸°í™” ì‹œì‘",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ë³€ê²½ëœ íŒŒì¼*: $FILE_COUNTê°œ\n$FILE_LIST"
                }
              }
            ]
          }
          EOF
          )

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"

      - name: Sync to Notion
        if: steps.changed-files.outputs.has_changes == 'true'
        id: sync-result
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ vars.NOTION_DATABASE_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          README_FILES='${{ steps.changed-files.outputs.readme_files }}'

          SUCCESS_COUNT=0
          FAIL_COUNT=0
          START_TIME=$(date +%s)

          echo "ë™ê¸°í™”í•  íŒŒì¼ ê°œìˆ˜: $(echo "$README_FILES" | jq 'length')"
          echo ""

          # README íŒŒì¼ ëª©ë¡ì„ í•œ ì¤„ì”© ì²˜ë¦¬
          while IFS= read -r FILE_PATH; do
            [ -z "$FILE_PATH" ] && continue

            echo "ğŸ” [DEBUG] ì²˜ë¦¬ ì¤‘: $FILE_PATH"

            # GitHub URL ìƒì„±
            GITHUB_URL="https://github.com/${GITHUB_REPOSITORY}/blob/${GITHUB_REF_NAME}/${FILE_PATH}"

            echo "======================================"
            echo "ì²˜ë¦¬ ì¤‘: $FILE_PATH"
            echo "URL: $GITHUB_URL"
            echo "======================================"

            # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            if python -X utf8 scripts/sync_to_notion.py "$GITHUB_URL"; then
              echo "âœ… ì„±ê³µ"
              ((SUCCESS_COUNT++))
              echo "ğŸ” [DEBUG] SUCCESS_COUNT=$SUCCESS_COUNT"
            else
              PYTHON_EXIT=$?
              echo "âŒ ì‹¤íŒ¨ (exit code: $PYTHON_EXIT)"
              ((FAIL_COUNT++))
              echo "ğŸ” [DEBUG] FAIL_COUNT=$FAIL_COUNT"
            fi

            echo ""
            # Rate limit ë°©ì§€
            sleep 2
          done < <(echo "$README_FILES" | jq -r '.[]')

          echo "ğŸ” [DEBUG] while ë£¨í”„ ì™„ë£Œ"
          echo "ğŸ” [DEBUG] ìµœì¢…: SUCCESS_COUNT=$SUCCESS_COUNT, FAIL_COUNT=$FAIL_COUNT"

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo ""
          echo "ì²˜ë¦¬ ì™„ë£Œ: ì„±ê³µ=$SUCCESS_COUNT, ì‹¤íŒ¨=$FAIL_COUNT, ì‹¤í–‰ì‹œê°„=${DURATION}ì´ˆ"

          # GitHub Output ì„¤ì • ë””ë²„ê¹…
          echo "ğŸ” [DEBUG] GITHUB_OUTPUT='$GITHUB_OUTPUT'"

          if [ -z "$GITHUB_OUTPUT" ]; then
            echo "âš ï¸ GITHUB_OUTPUTì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          else
            echo "ğŸ” [DEBUG] GITHUB_OUTPUT íŒŒì¼ì— ì“°ê¸° ì‹œì‘"
            echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT && echo "âœ… success_count ê¸°ë¡ë¨"
            echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT && echo "âœ… fail_count ê¸°ë¡ë¨"
            echo "duration=$DURATION" >> $GITHUB_OUTPUT && echo "âœ… duration ê¸°ë¡ë¨"
            echo "ğŸ” [DEBUG] GITHUB_OUTPUT íŒŒì¼ ë‚´ìš©:"
            cat $GITHUB_OUTPUT 2>/dev/null || echo "  (íŒŒì¼ ì½ê¸° ì‹¤íŒ¨)"
          fi

          # ì‹¤í–‰ ê²°ê³¼ì— ë”°ë¼ exit code ì„¤ì •
          echo ""
          echo "ğŸ” [DEBUG] Exit code ê²°ì •: FAIL_COUNT=$FAIL_COUNT"
          if [ $FAIL_COUNT -eq 0 ]; then
            echo "âœ… ëª¨ë“  ì‘ì—… ì„±ê³µ â†’ exit 0"
            exit 0
          else
            echo "âŒ ì‹¤íŒ¨í•œ ì‘ì—… ìˆìŒ â†’ exit 1"
            exit 1
          fi

      - name: Send Slack notification (Complete)
        if: always() && steps.changed-files.outputs.has_changes == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "â­ï¸ SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          SUCCESS_COUNT=${{ steps.sync-result.outputs.success_count || '0' }}
          FAIL_COUNT=${{ steps.sync-result.outputs.fail_count || '0' }}
          DURATION=${{ steps.sync-result.outputs.duration || '0' }}

          if [ "$FAIL_COUNT" -eq 0 ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="ì„±ê³µ"
          else
            STATUS_EMOJI="âš ï¸"
            STATUS_TEXT="ì¼ë¶€ ì‹¤íŒ¨"
          fi

          PAYLOAD=$(cat <<EOF
          {
            "text": "$STATUS_EMOJI Notion ë™ê¸°í™” $STATUS_TEXT",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ì²˜ë¦¬ ê²°ê³¼*\nâœ… ì„±ê³µ: $SUCCESS_COUNTê°œ\nâŒ ì‹¤íŒ¨: $FAIL_COUNTê°œ\nâ±ï¸ ì‹¤í–‰ ì‹œê°„: ${DURATION}ì´ˆ"
                }
              }
            ]
          }
          EOF
          )

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"
