name: Sync to Notion

on:
  push:
    branches:
      - main
    paths:
      - 'ÌîÑÎ°úÍ∑∏ÎûòÎ®∏Ïä§/**'

jobs:
  sync:
    name: Sync changed problems to Notion
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install requests python-dotenv

      - name: Detect changed README files
        id: changed-files
        run: |
          # Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep '^ÌîÑÎ°úÍ∑∏ÎûòÎ®∏Ïä§/.*README\.md$' || true)
          else
            # Ï¥àÍ∏∞ Ïª§Î∞ãÏù∏ Í≤ΩÏö∞ Î™®Îì† README ÌååÏùº Ï≤òÎ¶¨
            CHANGED_FILES=$(git ls-files 'ÌîÑÎ°úÍ∑∏ÎûòÎ®∏Ïä§/**/README.md' || true)
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "Î≥ÄÍ≤ΩÎêú README ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Î≥ÄÍ≤ΩÎêú README ÌååÏùº:"
            echo "$CHANGED_FILES"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # JSON Î∞∞Ïó¥Î°ú Î≥ÄÌôò
            README_ARRAY=$(echo "$CHANGED_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "readme_files=$README_ARRAY" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification (Start)
        if: steps.changed-files.outputs.has_changes == 'true' && secrets.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          README_FILES='${{ steps.changed-files.outputs.readme_files }}'
          FILE_COUNT=$(echo "$README_FILES" | jq 'length')

          # ÌååÏùº Î™©Î°ù ÏÉùÏÑ±
          FILE_LIST=$(echo "$README_FILES" | jq -r '.[]' | sed 's/^/‚Ä¢ /')

          PAYLOAD=$(cat <<EOF
          {
            "text": "üöÄ Notion ÎèôÍ∏∞Ìôî ÏãúÏûë",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Î≥ÄÍ≤ΩÎêú ÌååÏùº*: $FILE_COUNTÍ∞ú\n$FILE_LIST"
                }
              }
            ]
          }
          EOF
          )

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"

      - name: Sync to Notion
        if: steps.changed-files.outputs.has_changes == 'true'
        id: sync-result
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          README_FILES='${{ steps.changed-files.outputs.readme_files }}'

          SUCCESS_COUNT=0
          FAIL_COUNT=0
          START_TIME=$(date +%s)

          echo "ÎèôÍ∏∞ÌôîÌï† ÌååÏùº Í∞úÏàò: $(echo "$README_FILES" | jq 'length')"
          echo ""

          # Í∞Å README ÌååÏùºÏóê ÎåÄÌï¥ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
          echo "$README_FILES" | jq -r '.[]' | while read -r FILE_PATH; do
            # GitHub URL ÏÉùÏÑ±
            GITHUB_URL="https://github.com/${GITHUB_REPOSITORY}/blob/${GITHUB_REF_NAME}/${FILE_PATH}"

            echo "======================================"
            echo "Ï≤òÎ¶¨ Ï§ë: $FILE_PATH"
            echo "URL: $GITHUB_URL"
            echo "======================================"

            # Python Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
            if python -X utf8 scripts/sync_to_notion.py "$GITHUB_URL"; then
              echo "‚úÖ ÏÑ±Í≥µ"
              ((SUCCESS_COUNT++))
            else
              echo "‚ùå Ïã§Ìå®"
              ((FAIL_COUNT++))
            fi

            echo ""
            # Rate limit Î∞©ÏßÄ
            sleep 2
          done

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "Ï≤òÎ¶¨ ÏôÑÎ£å: ÏÑ±Í≥µ=$SUCCESS_COUNT, Ïã§Ìå®=$FAIL_COUNT, Ïã§ÌñâÏãúÍ∞Ñ=${DURATION}Ï¥à"
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT

      - name: Send Slack notification (Complete)
        if: always() && steps.changed-files.outputs.has_changes == 'true' && secrets.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          SUCCESS_COUNT=${{ steps.sync-result.outputs.success_count || '0' }}
          FAIL_COUNT=${{ steps.sync-result.outputs.fail_count || '0' }}
          DURATION=${{ steps.sync-result.outputs.duration || '0' }}

          if [ "$FAIL_COUNT" -eq 0 ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="ÏÑ±Í≥µ"
          else
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="ÏùºÎ∂Ä Ïã§Ìå®"
          fi

          PAYLOAD=$(cat <<EOF
          {
            "text": "$STATUS_EMOJI Notion ÎèôÍ∏∞Ìôî $STATUS_TEXT",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Ï≤òÎ¶¨ Í≤∞Í≥º*\n‚úÖ ÏÑ±Í≥µ: $SUCCESS_COUNTÍ∞ú\n‚ùå Ïã§Ìå®: $FAIL_COUNTÍ∞ú\n‚è±Ô∏è Ïã§Ìñâ ÏãúÍ∞Ñ: ${DURATION}Ï¥à"
                }
              }
            ]
          }
          EOF
          )

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"
